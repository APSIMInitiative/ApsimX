name: Run model validations
permissions:
  contents: read # access to check out code and install dependencies

env:
  APSIM_WORKFLOW_DLL_LOCATION: "/home/runner/work/ApsimX/ApsimX/bin/Release/net8.0/APSIM.Workflow.dll"
  APSIM_FILE_DIR_TO_RUN_LOCATION: "/home/runner/work/ApsimX/ApsimX/Tests/Validation/WorkFloTest/" 
  ALL_APSIM_FILES: ""
  
# Determines when this workflow is triggered. 
on:
  push:
  pull_request:
    branches: [ master ]

jobs:
  run-model-validations:
    name: run-model-validations
    runs-on: ubuntu-latest
    env:
      ALL_APSIM_FILES: ""
    steps:
    - uses: actions/checkout@v4

    # - name: get PR author id
    #   run: "echo GITHUB_ACTOR: $GITHUB_ACTOR"

    - name: Setup .NET Core
      uses: actions/setup-dotnet@v4

    - name: Build
      run: dotnet build --configuration Release

    - name: Log in to Docker Hub
      uses: docker/login-action@f4ef78c080cd8ba55a85445d5b36e214a81df20a
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Extract metadata (tags, labels) for Docker
      id: meta
      uses: docker/metadata-action@9ec57ed1fcdbf14dcef7dfbe97b2010124a938b7
      with:
        images: ric394/apsimx
        flavor: latest=true
        tags: |
          type=ref,event=branch
          type=ref,event=pr

    - name: Build and push Docker image
      id: push
      uses: docker/build-push-action@3b5e8027fcad23fda98b2e3ac259d8d67585f671
      with:
        context: .
        file: ./Dockerfile
        target: build
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}

    - name: output the tags from 'meta' step
      run: |
        echo "Tags: ${{ steps.meta.outputs.tags }}"
        echo "Labels: ${{ steps.meta.outputs.labels }}"

    - name: Create azure jobs for all validation directories
      id: submit_azure_jobs
      run: |
        DOCKER_IMAGE_TAG=$DOCKER_METADATA_OUTPUT_VERSION
        echo "DOCKER_IMAGE_TAG: ${DOCKER_IMAGE_TAG}"

        mapfile -t validation_dirs_array < <( dotnet ./bin/Release/net8.0/APSIM.Workflow.dll -l)
        printf '%s\n' "${validation_dirs_array[@]}"
        # echo "Begin printing vars in loop..."
        # DOCKER_IMAGE_TAG = cut -d ':' -f 2 ${{ steps.meta.outputs.tags }}
        # for directory in "${validation_dirs_array[@]}"; do
        #   echo "Adding .env file to ${directory}"
        #   echo "${{ secrets.AZURE_ENV_CONTENTS }}" > "$directory/.env"
        #   echo ".env successfully added to ${directory}"
        #   dotnet ./bin/Release/net8.0/APSIM.Workflow.dll -d "$directory" -g $GITHUB_ACTOR -t $DOCKER_IMAGE_TAG
        # done
        # Puts the array into a github variable
        # echo "ALL_APSIM_FILES=${validation_dirs_array[@]}" >> $GITHUB_ENV

    - name: Print workflow submit success summary markdown
      if: success()
      run: |
        echo "## Workflow submit success summary :tada:" >> $GITHUB_STEP_SUMMARY
        echo 'All jobs submitted to Azure successfully!' >> $GITHUB_STEP_SUMMARY

    - name: Print workflow submit failure summary markdown
      if: failure()
      run: |
        echo "## Workflow submit failure summary :sob:" >> $GITHUB_STEP_SUMMARY
        echo "The workflow failed to submit all jobs to Azure." >> $GITHUB_STEP_SUMMARY
        echo "Reason: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "Please check the logs for more information." >> $GITHUB_STEP_SUMMARY

    # - name: Print all the file names
    #   run: |
    #     echo all apsim files:
    #     # echo "$ALL_APSIM_FILES"
    #     printf '%s\n' "${ALL_APSIM_FILES[@]}"

    # - name: Run a validation via WorkFlo on Azure for each validation directory
    #   run: |
    #     for validation_dir in ${ALL_APSIM_FILES[@]}; do
    #       echo "Running validation for $validation_dir"
    #       # echo Add env to directory before zipping - required to run the validation
    #       # echo "${{ secrets.AZURE_ENV_CONTENTS }}" > "$validation_dir.env"
    #       # dotnet ${{ env.APSIM_WORKFLOW_DLL_LOCATION }} "$validation_dir" --verbose
    #     done



    # - name: Add env to directory before zipping
    #   run:  echo "${{ secrets.AZURE_ENV_CONTENTS }}" > ${{ env.APSIM_FILE_DIR_TO_RUN_LOCATION }}.env 

    # - name: Run a validation via WorkFlo on Azure
    #   run: dotnet ${{ env.APSIM_WORKFLOW_DLL_LOCATION }} ${{ env.APSIM_FILE_DIR_TO_RUN_LOCATION }} --verbose